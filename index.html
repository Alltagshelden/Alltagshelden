<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alltagshelden – Preview 0.3 Light</title>
  <style>
    html, body { margin:0; padding:0; background:#0e0f12; height:100%; }
    #game { display:flex; align-items:center; justify-content:center; height:100%; }
    .hint { position: absolute; top: 10px; left: 10px; font-family: monospace; color:#ddd; background:rgba(0,0,0,0.4); padding:6px 10px; border:1px solid #555; border-radius:6px; }
    canvas { image-rendering: pixelated; }
  </style>
</head>
<body>
  <div id="game"></div>
  <div class="hint">Tipp: Drücke <b>H</b> für die Steuerung</div>
  <!-- Phaser via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>
  <script>
  // --- Simple localStorage wrapper for highscores ---
  const HS_KEY = 'alltagshelden_highscores_v1';
  function loadHighscores(){ try{ return JSON.parse(localStorage.getItem(HS_KEY))||[] }catch(e){ return [] } }
  function saveHighscores(arr){ localStorage.setItem(HS_KEY, JSON.stringify(arr)); }
  function addHighscore(entry){
    const list = loadHighscores();
    list.push(entry);
    list.sort((a,b)=> b.points - a.points);
    const MAX = 10; // Top 10
    while(list.length>MAX) list.pop();
    saveHighscores(list);
  }

  const WIDTH=960, HEIGHT=540;
  const config = { type: Phaser.AUTO, width: WIDTH, height: HEIGHT, parent: 'game',
    physics: { default: 'arcade', arcade: { gravity: { y: 900 }, debug:false }},
    scene: [Boot, Title, Controls, Highscores, Game]
  };

  let selectedChar = 'Manuel'; // default

  function Boot(){ Phaser.Scene.call(this,{key:'Boot'}) }
  Boot.prototype = Object.create(Phaser.Scene.prototype);
  Boot.prototype.constructor = Boot;
  Boot.prototype.preload = function(){
    this.load.image('title','assets/title.png');
    this.load.image('coin','assets/coin.png');
    // tiny 8x8 pixel rectangles for player/enemy
    this.createPixel('player','#e43d3d','player');
    this.createPixel('#4caf50','#4caf50','platform'); // not used, but keep
  };
  Boot.prototype.createPixel = function(color, color2, key){
    const g = this.make.graphics({x:0,y:0,add:false});
    g.fillStyle(Phaser.Display.Color.HexStringToColor(color).color,1);
    g.fillRect(0,0,16,24);
    g.generateTexture(typeof key==='string'?key:'player',16,24);
    g.destroy();
  }
  Boot.prototype.create = function(){ this.scene.start('Title'); }

  // --- UI helpers ---
  function makeButton(scene, x,y, text, cb){
    const btn = scene.add.rectangle(x,y,220,44,0x2b2f36).setStrokeStyle(2,0xffffff).setInteractive({useHandCursor:true});
    const label = scene.add.text(x,y,text,{fontFamily:'monospace', fontSize: '16px', color:'#fff'}).setOrigin(0.5);
    btn.on('pointerover', ()=> btn.setFillStyle(0x38404a));
    btn.on('pointerout',  ()=> btn.setFillStyle(0x2b2f36));
    btn.on('pointerdown', cb);
    return {btn,label};
  }

  // --- Title Scene ---
  function Title(){ Phaser.Scene.call(this,{key:'Title'}) }
  Title.prototype = Object.create(Phaser.Scene.prototype);
  Title.prototype.constructor = Title;
  Title.prototype.create = function(){
    this.cameras.main.setBackgroundColor('#0e0f12');
    const img = this.add.image(WIDTH/2, 170, 'title').setOrigin(0.5).setScale( Math.min(800/imgWidth(this,'title'), 1) );
    const titleTxt = this.add.text(WIDTH/2, 40, 'ALLTAGSHELDEN – REMOTE SUPPORT', {fontFamily:'monospace', fontSize:'20px', color:'#fff'}).setOrigin(0.5);
    makeButton(this, WIDTH/2, 300, 'Start', ()=> this.scene.start('Game'));
    makeButton(this, WIDTH/2, 350, 'Highscores', ()=> this.scene.start('Highscores'));
    makeButton(this, WIDTH/2, 400, 'Steuerung', ()=> this.scene.start('Controls'));
    makeButton(this, WIDTH/2, 450, 'Was ist neu?', ()=> {
      // Preview-Light Hinweis: README nutzen
      this.add.rectangle(WIDTH/2, HEIGHT/2, 700, 220, 0x000000, 0.9).setStrokeStyle(2,0xffffff);
      this.add.text(WIDTH/2, HEIGHT/2-60, 'Changelog / Was ist neu?', {fontFamily:'monospace', fontSize:'18px', color:'#fff'}).setOrigin(0.5);
      this.add.text(WIDTH/2, HEIGHT/2-10, 'In dieser Preview-Light steht der Changelog in der README.txt', {fontFamily:'monospace', fontSize:'14px', color:'#ddd'}).setOrigin(0.5);
      this.add.text(WIDTH/2, HEIGHT/2+30, 'Demnächst direkt hier im Spiel abrufbar.', {fontFamily:'monospace', fontSize:'14px', color:'#aaa'}).setOrigin(0.5);
    });
    // Character select (simple cycle on key C)
    this.add.text(WIDTH/2, 240, 'Charakter (mit C wechseln): '+selectedChar, {fontFamily:'monospace', fontSize:'14px', color:'#ccc'}).setOrigin(0.5).setName('charLabel');
    this.input.keyboard.on('keydown-C', ()=>{
      const order = ['Manuel','Marek','Dirk'];
      const idx = (order.indexOf(selectedChar)+1)%order.length;
      selectedChar = order[idx];
      this.children.getByName('charLabel').setText('Charakter (mit C wechseln): '+selectedChar);
    });
  };
  function imgWidth(scene,key){ return scene.textures.get(key).getSourceImage().width }

  // --- Controls Scene ---
  function Controls(){ Phaser.Scene.call(this,{key:'Controls'}) }
  Controls.prototype = Object.create(Phaser.Scene.prototype);
  Controls.prototype.constructor = Controls;
  Controls.prototype.create = function(){
    this.cameras.main.setBackgroundColor('#0e0f12');
    this.add.text(WIDTH/2, 60, 'STEUERUNG', {fontFamily:'monospace', fontSize:'20px', color:'#fff'}).setOrigin(0.5);
    const lines = [
      'Bewegen: A/D oder ←/→',
      'Springen: W / ↑ / Leertaste',
      'Schießen: F / Strg',
      'Waffen wechseln: 1–5',
      'Spezialfähigkeit: Q (Platzhalter)',
      'Pause/Legende: H oder ESC'
    ];
    const panel = this.add.rectangle(WIDTH/2, HEIGHT/2, 600, 260, 0x000000, 0.85).setStrokeStyle(2,0xffffff);
    this.add.text(panel.x-260, panel.y-110, lines.join('\n'), {fontFamily:'monospace', fontSize:'16px', color:'#ddd'});
    makeButton(this, WIDTH/2, HEIGHT-60, 'Zurück', ()=> this.scene.start('Title'));
  };

  // --- Highscores Scene ---
  function Highscores(){ Phaser.Scene.call(this,{key:'Highscores'}) }
  Highscores.prototype = Object.create(Phaser.Scene.prototype);
  Highscores.prototype.constructor = Highscores;
  Highscores.prototype.create = function(){
    this.cameras.main.setBackgroundColor('#0e0f12');
    this.add.text(WIDTH/2, 60, 'TOP 10 HIGHSCORES', {fontFamily:'monospace', fontSize:'20px', color:'#fff'}).setOrigin(0.5);
    const list = loadHighscores();
    const panel = this.add.rectangle(WIDTH/2, HEIGHT/2, 700, 360, 0x000000, 0.85).setStrokeStyle(2,0xffffff);
    const header = 'Platz  Name           Punkte    Level   Coins';
    const rows = list.map((e,i)=> `${String(i+1).padEnd(6)} ${e.name.padEnd(14)} ${String(e.points).padEnd(9)} ${String(e.level).padEnd(7)} ${e.coins}`);
    this.add.text(panel.x-330, panel.y-150, header+'\n'+'-'.repeat(52)+'\n'+ (rows.join('\n')||'(noch keine Einträge)'), {fontFamily:'monospace', fontSize:'14px', color:'#ddd'});
    makeButton(this, WIDTH/2, HEIGHT-50, 'Zurück', ()=> this.scene.start('Title'));
  };

  // --- Game Scene (Level 1: Lagerhalle, simple platforms, coins, enemies) ---
  function Game(){ Phaser.Scene.call(this,{key:'Game'}) }
  Game.prototype = Object.create(Phaser.Scene.prototype);
  Game.prototype.constructor = Game;
  Game.prototype.create = function(){
    this.cameras.main.setBackgroundColor('#1a1d22');
    this.input.keyboard.on('keydown-H', ()=> this.showControlsOverlay());
    // world
    this.platforms = this.physics.add.staticGroup();
    // ground
    this.platforms.create(WIDTH/2, HEIGHT-10, null).setDisplaySize(WIDTH, 20).refreshBody().setVisible(false);
    // some crates/platforms
    const plats = [
      {x:200,y:440,w:180,h:14},
      {x:420,y:360,w:160,h:14},
      {x:620,y:300,w:180,h:14},
      {x:820,y:250,w:160,h:14},
      {x:300,y:220,w:120,h:14}
    ];
    plats.forEach(p=>{
      const r = this.add.rectangle(p.x,p.y,p.w,p.h,0x2b2f36).setStrokeStyle(1,0x777777);
      this.physics.add.existing(r, true);
      this.platforms.add(r);
    });

    // player
    this.player = this.physics.add.sprite(100, HEIGHT-60, 'player').setCollideWorldBounds(true);
    this.physics.add.collider(this.player, this.platforms);
    this.cursors = this.input.keyboard.createCursorKeys();
    this.keys = this.input.keyboard.addKeys('A,D,W,SPACE,F,Q,ONE,TWO,THREE,FOUR,FIVE');

    // coins
    this.coins = this.physics.add.group({ allowGravity:false });
    const coinPos = [(240,400),(420,320),(620,260),(820,210),(300,180),(900,480),(120,480)];
    coinPos.forEach(pos=> this.coins.create(pos[0],pos[1],'coin').setScale(0.8).setCircle(20).setOffset(6,6));
    this.tweens.add({ targets: this.coins.getChildren(), angle: 360, duration: 2000, repeat:-1 });

    // enemies (Kartonkopf = small walker, Gabelstapler = bigger mover)
    this.enemies = this.physics.add.group({ allowGravity:true });
    const e1 = this.enemies.create(520, 320-20, 'player').setTint(0xffcc66).setScale(0.8).setBounce(0);
    e1.body.setSize(16,18);
    e1.vx = -80;
    const e2 = this.enemies.create(760, 250-20, 'player').setTint(0x99d1ff).setScale(1.2);
    e2.body.setSize(16,20);
    e2.vx = 60;
    this.physics.add.collider(this.enemies, this.platforms);

    // overlaps
    this.physics.add.overlap(this.player, this.coins, (player,coin)=>{
      coin.destroy(); this.sound.play('pickup');
      this.collected = (this.collected||0)+1;
      this.points = (this.points||0)+100;
    });
    this.physics.add.collider(this.player, this.enemies, (pl, enemy)=>{
      // simple damage → reset player
      this.sound.play('hit'); this.cameras.main.shake(120,0.004);
      pl.setVelocity(0,-200);
      this.lives = (this.lives||3)-1;
      if(this.lives<=0){ this.gameOver(); }
    });

    // shooting
    this.bullets = this.physics.add.group({ allowGravity:false });
    this.physics.add.overlap(this.bullets, this.enemies, (b,e)=>{ b.destroy(); e.destroy(); this.points=(this.points||0)+150; });
    this.lastShot = 0;

    // HUD
    this.points=0; this.collected=0; this.levelNum=1; this.lives=3;

    // sounds
    this.sound.add('pickup'); this.sound.add('hit');
    this.load.audio('shoot','assets/shoot.wav');
  };
  Game.prototype.update = function(time,delta){
    // move enemies horizontally and bounce on edges/platforms extents
    this.enemies.getChildren().forEach(e=>{
      e.body.setVelocityX(e.vx);
      // simple patrol
      if(e.x<80){ e.vx = Math.abs(e.vx); }
      if(e.x>WIDTH-80){ e.vx = -Math.abs(e.vx); }
    });

    // player control
    const sp = 180;
    if(this.cursors.left.isDown || this.keys.A.isDown){ this.player.setVelocityX(-sp); }
    else if(this.cursors.right.isDown || this.keys.D.isDown){ this.player.setVelocityX(sp); }
    else{ this.player.setVelocityX(0); }

    const onGround = this.player.body.blocked.down;
    if((this.cursors.up.isDown || this.keys.W.isDown || this.keys.SPACE.isDown) && onGround){
      this.player.setVelocityY(-380);
    }

    // shoot (F or CTRL)
    if( (this.keys.F.isDown || this.cursors.ctrlKey) && time>this.lastShot+250 ){
      const dir = (this.cursors.left.isDown||this.keys.A.isDown)? -1 : 1;
      const b = this.bullets.create(this.player.x+dir*16, this.player.y-2, null);
      b.body.setCircle(3); b.body.setOffset(-3,-3);
      const g = this.add.graphics(); g.fillStyle(0xe43d3d,1); g.fillCircle(0,0,3); g.generateTexture('bullet',6,6); g.destroy();
      b.setTexture('bullet');
      b.setVelocityX(400*dir);
      this.lastShot = time; this.sound.play('shoot');
      // limit bullet lifespan so it won't fly forever
      this.time.delayedCall(900, ()=> b.destroy(), [], this);
    }

    // HUD drawing
    if(!this.hud){
      this.hud = this.add.text(10,10,'',{fontFamily:'monospace', fontSize:'14px', color:'#fff'}).setScrollFactor(0);
    }
    this.hud.setText(`Punkte: ${this.points}   Coins: ${this.collected}   Leben: ${this.lives}   Level: ${this.levelNum}`);

    // win condition → if all coins collected, end level
    if(this.coins.getChildren().length===0){ this.endLevel(); }
  };
  Game.prototype.showControlsOverlay = function(){
    const panel = this.add.rectangle(WIDTH/2, HEIGHT/2, 600, 260, 0x000000, 0.9).setStrokeStyle(2,0xffffff);
    const lines = [
      'Bewegen: A/D oder ←/→',
      'Springen: W / ↑ / Leertaste',
      'Schießen: F / Strg',
      'Waffen wechseln: 1–5',
      'Spezialfähigkeit: Q (Platzhalter)',
      'Pause/Legende: H oder ESC'
    ];
    this.add.text(panel.x-260, panel.y-110, lines.join('\n'), {fontFamily:'monospace', fontSize:'16px', color:'#ddd'});
    this.input.keyboard.once('keydown-ESC', ()=> panel.destroy());
    this.input.keyboard.once('keydown-H', ()=> panel.destroy());
  };
  Game.prototype.endLevel = function(){
    // simple finish → enter name and save highscore, then go to Highscores
    const name = prompt('Name für Highscore eintragen:' , selectedChar);
    addHighscore({ name: name||selectedChar, points:this.points, level:this.levelNum, coins:this.collected });
    this.scene.start('Highscores');
  };
  Game.prototype.gameOver = function(){
    const name = prompt('Game Over. Name für Highscore:' , selectedChar);
    addHighscore({ name: name||selectedChar, points:this.points, level:this.levelNum, coins:this.collected });
    this.scene.start('Highscores');
  };

  new Phaser.Game(config);
  </script>
</body>
</html>
