<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alltagshelden – Preview 0.3 Light (Fixed3)</title>
  <style>
    html,body{margin:0;background:#0e0f12;height:100%}#game{display:flex;align-items:center;justify-content:center;height:100%}
    .hint{position:absolute;top:10px;left:10px;font-family:monospace;color:#ddd;background:rgba(0,0,0,.4);padding:6px 10px;border:1px solid #555;border-radius:6px}
    canvas{image-rendering:pixelated}
  </style>
</head>
<body>
  <div id="game"></div>
  <div class="hint">Tipp: Drücke <b>H</b> für die Steuerung</div>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>
  <script>
  const HS_KEY='alltagshelden_highscores_v1';
  function loadHighscores(){try{return JSON.parse(localStorage.getItem(HS_KEY))||[]}catch(e){return []}}
  function saveHighscores(a){localStorage.setItem(HS_KEY,JSON.stringify(a))}
  function addHighscore(e){const l=loadHighscores();l.push(e);l.sort((a,b)=>b.points-a.points);while(l.length>10)l.pop();saveHighscores(l)}
  const WIDTH=960,HEIGHT=540;
  const config={type:Phaser.AUTO,width:WIDTH,height:HEIGHT,parent:'game',physics:{default:'arcade',arcade:{gravity:{y:900},debug:false}},scene:[Boot,Title,Controls,Highscores,Game]};
  let selectedChar='Manuel';
  // --- Boot ---
  function Boot(){Phaser.Scene.call(this,{key:'Boot'})}
  Boot.prototype=Object.create(Phaser.Scene.prototype);Boot.prototype.constructor=Boot;
  Boot.prototype.preload=function(){
    this.load.image('title','assets/title.png');
    this.load.image('coin','assets/coin.png');
    // audio preload
    this.load.audio('pickup','assets/pickup.wav');
    this.load.audio('hit','assets/hit.wav');
    this.load.audio('shoot','assets/shoot.wav');
    // generate textures (player & bullet) once
    let g=this.make.graphics({x:0,y:0,add:false});
    g.fillStyle(0xe43d3d,1);g.fillRect(0,0,16,24);g.generateTexture('player',16,24);g.destroy();
    g=this.make.graphics({x:0,y:0,add:false});
    g.fillStyle(0xe43d3d,1);g.fillCircle(3,3,3);g.generateTexture('bullet',6,6);g.destroy();
  }
  Boot.prototype.create=function(){this.scene.start('Title')}
  function makeButton(s,x,y,t,cb){const b=s.add.rectangle(x,y,220,44,0x2b2f36).setStrokeStyle(2,0xffffff).setInteractive({useHandCursor:true});const L=s.add.text(x,y,t,{fontFamily:'monospace',fontSize:'16px',color:'#fff'}).setOrigin(0.5);b.on('pointerover',()=>b.setFillStyle(0x38404a));b.on('pointerout',()=>b.setFillStyle(0x2b2f36));b.on('pointerdown',cb);return{b,L}}
  // --- Title ---
  function Title(){Phaser.Scene.call(this,{key:'Title'})}
  Title.prototype=Object.create(Phaser.Scene.prototype);Title.prototype.constructor=Title;
  Title.prototype.create=function(){
    this.cameras.main.setBackgroundColor('#0e0f12');
    this.add.image(WIDTH/2,170,'title').setOrigin(0.5);
    this.add.text(WIDTH/2,40,'ALLTAGSHELDEN – REMOTE SUPPORT',{fontFamily:'monospace',fontSize:'20px',color:'#fff'}).setOrigin(0.5);
    makeButton(this,WIDTH/2,300,'Start',()=>this.scene.start('Game'));
    makeButton(this,WIDTH/2,350,'Highscores',()=>this.scene.start('Highscores'));
    makeButton(this,WIDTH/2,400,'Steuerung',()=>this.scene.start('Controls'));
    makeButton(this,WIDTH/2,450,'Was ist neu?',()=>{
      this.add.rectangle(WIDTH/2,HEIGHT/2,700,220,0x000000,0.9).setStrokeStyle(2,0xffffff);
      this.add.text(WIDTH/2,HEIGHT/2-60,'Changelog / Was ist neu?',{fontFamily:'monospace',fontSize:'18px',color:'#fff'}).setOrigin(0.5);
      this.add.text(WIDTH/2,HEIGHT/2-10,'In dieser Preview-Light steht der Changelog in der README.txt',{fontFamily:'monospace',fontSize:'14px',color:'#ddd'}).setOrigin(0.5);
      this.add.text(WIDTH/2,HEIGHT/2+30,'Demnächst direkt hier im Spiel abrufbar.',{fontFamily:'monospace',fontSize:'14px',color:'#aaa'}).setOrigin(0.5);
    });
    this.add.text(WIDTH/2,240,'Charakter (mit C wechseln): '+selectedChar,{fontFamily:'monospace',fontSize:'14px',color:'#ccc'}).setOrigin(0.5).setName('charLabel');
    this.input.keyboard.on('keydown-C',()=>{const o=['Manuel','Marek','Dirk'];const i=(o.indexOf(selectedChar)+1)%o.length;selectedChar=o[i];this.children.getByName('charLabel').setText('Charakter (mit C wechseln): '+selectedChar);});
  }
  // --- Controls ---
  function Controls(){Phaser.Scene.call(this,{key:'Controls'})}
  Controls.prototype=Object.create(Phaser.Scene.prototype);Controls.prototype.constructor=Controls;
  Controls.prototype.create=function(){
    this.cameras.main.setBackgroundColor('#0e0f12');
    this.add.text(WIDTH/2,60,'STEUERUNG',{fontFamily:'monospace',fontSize:'20px',color:'#fff'}).setOrigin(0.5);
    const lines=['Bewegen: A/D oder ←/→','Springen: W / ↑ / Leertaste','Schießen: F / Strg','Waffen wechseln: 1–5','Spezialfähigkeit: Q (Platzhalter)','Pause/Legende: H oder ESC'];
    const p=this.add.rectangle(WIDTH/2,HEIGHT/2,600,260,0x000000,0.85).setStrokeStyle(2,0xffffff);
    this.add.text(p.x-260,p.y-110,lines.join('\n'),{fontFamily:'monospace',fontSize:'16px',color:'#ddd'});
    makeButton(this,WIDTH/2,HEIGHT-60,'Zurück',()=>this.scene.start('Title'));
  }
  // --- Highscores ---
  function Highscores(){Phaser.Scene.call(this,{key:'Highscores'})}
  Highscores.prototype=Object.create(Phaser.Scene.prototype);Highscores.prototype.constructor=Highscores;
  Highscores.prototype.create=function(){
    this.cameras.main.setBackgroundColor('#0e0f12');
    this.add.text(WIDTH/2,60,'TOP 10 HIGHSCORES',{fontFamily:'monospace',fontSize:'20px',color:'#fff'}).setOrigin(0.5);
    const list=loadHighscores();
    const p=this.add.rectangle(WIDTH/2,HEIGHT/2,700,360,0x000000,0.85).setStrokeStyle(2,0xffffff);
    const header='Platz  Name           Punkte    Level   Coins';
    const rows=list.map((e,i)=>`${String(i+1).padEnd(6)} ${e.name.padEnd(14)} ${String(e.points).padEnd(9)} ${String(e.level).padEnd(7)} ${e.coins}`);
    this.add.text(p.x-330,p.y-150,header+'\n'+'-'.repeat(52)+'\n'+(rows.length?rows.join('\n'):'(noch keine Einträge)'),{fontFamily:'monospace',fontSize:'14px',color:'#ddd'});
    makeButton(this,WIDTH/2,HEIGHT-50,'Zurück',()=>this.scene.start('Title'));
  }
  // --- Game ---
  function Game(){Phaser.Scene.call(this,{key:'Game'})}
  Game.prototype=Object.create(Phaser.Scene.prototype);Game.prototype.constructor=Game;
  Game.prototype.create=function(){
    this.cameras.main.setBackgroundColor('#1a1d22');
    // debug toggle & controls overlay
    this.input.keyboard.on('keydown-H',()=>this.showControlsOverlay());
    this.debugOn=false; this.input.keyboard.on('keydown-D',()=>{this.debugOn=!this.debugOn;if(this.debugText)this.debugText.setVisible(this.debugOn);});
    this.debugText=this.add.text(10,28,'',{fontFamily:'monospace',fontSize:'12px',color:'#9cf'}).setScrollFactor(0).setVisible(false);

    // platforms
    this.platforms=this.physics.add.staticGroup();
    this.platforms.create(WIDTH/2,HEIGHT-10,null).setDisplaySize(WIDTH,20).refreshBody().setVisible(false);
    [{x:200,y:440,w:180,h:14},{x:420,y:360,w:160,h:14},{x:620,y:300,w:180,h:14},{x:820,y:250,w:160,h:14},{x:300,y:220,w:120,h:14}].forEach(p=>{
      const r=this.add.rectangle(p.x,p.y,p.w,p.h,0x2b2f36).setStrokeStyle(1,0x777777);
      this.physics.add.existing(r,true); this.platforms.add(r);
    });

    // player
    this.player=this.physics.add.sprite(100,HEIGHT-60,'player').setCollideWorldBounds(true);
    this.physics.add.collider(this.player,this.platforms);
    this.cursors=this.input.keyboard.createCursorKeys();
    this.keys=this.input.keyboard.addKeys('A,D,W,SPACE,F,Q');

    // coins
    this.coins=this.physics.add.group({allowGravity:false});
    const coinPos=[[240,400],[420,320],[620,260],[820,210],[300,180],[900,480],[120,480]];
    coinPos.forEach(pos=> this.coins.create(pos[0],pos[1],'coin').setScale(0.8).setCircle(20).setOffset(6,6));
    this.tweens.add({targets:this.coins.getChildren(),angle:360,duration:2000,repeat:-1});
    this.physics.add.overlap(this.player,this.coins,(player,coin)=>{
      coin.destroy(); this.sound.play('pickup');
      this.collected=(this.collected||0)+1;
      this.points=(this.points||0)+100;
    });

    // enemies
    this.enemies=this.physics.add.group({allowGravity:true});
    const e1=this.enemies.create(520,300,'player').setTint(0xffcc66).setScale(0.8); e1.vx=-80;
    const e2=this.enemies.create(760,230,'player').setTint(0x99d1ff).setScale(1.2); e2.vx=60;
    this.physics.add.collider(this.enemies,this.platforms);
    this.physics.add.collider(this.player,this.enemies,(pl,enemy)=>{
      this.sound.play('hit'); this.cameras.main.shake(120,0.004);
      pl.setVelocity(0,-200);
      this.lives=(this.lives||3)-1;
      if(this.lives<=0){ this.gameOver(); }
    });

    // bullets
    this.bullets=this.physics.add.group({allowGravity:false});
    this.physics.add.overlap(this.bullets,this.enemies,(b,e)=>{ b.destroy(); e.destroy(); this.points=(this.points||0)+150; });
    this.lastShot=0;

    // HUD
    this.points=0; this.collected=0; this.levelNum=1; this.lives=3;
    this.hud=this.add.text(10,10,'',{fontFamily:'monospace',fontSize:'14px',color:'#fff'}).setScrollFactor(0);
  };
  Game.prototype.update=function(time,delta){
    // enemy patrol
    this.enemies.getChildren().forEach(e=>{
      e.body.setVelocityX(e.vx);
      if(e.x<80){ e.vx=Math.abs(e.vx); }
      if(e.x>WIDTH-80){ e.vx=-Math.abs(e.vx); }
    });

    // movement
    const sp=180;
    if(this.cursors.left.isDown||this.keys.A.isDown){ this.player.setVelocityX(-sp); }
    else if(this.cursors.right.isDown||this.keys.D.isDown){ this.player.setVelocityX(sp); }
    else{ this.player.setVelocityX(0); }
    const onGround=this.player.body.blocked.down;
    if((this.cursors.up.isDown||this.keys.W.isDown||this.keys.SPACE.isDown)&&onGround){ this.player.setVelocityY(-380); }

    // shoot
    if(this.keys.F.isDown && time>this.lastShot+250){
      const dir=(this.cursors.left.isDown||this.keys.A.isDown)?-1:1;
      const b=this.bullets.create(this.player.x+dir*16,this.player.y-2,'bullet'); b.setVelocityX(400*dir);
      this.lastShot=time; this.sound.play('shoot');
      this.time.delayedCall(900,()=> b.destroy(),[],this);
    }

    // HUD
    this.hud.setText(`Punkte: ${this.points}   Coins: ${this.collected}   Leben: ${this.lives}   Level: ${this.levelNum}`);

    // win
    if(this.coins.getChildren().length===0){ this.endLevel(); }

    if(this.debugOn){
      this.debugText.setText(`Char:${selectedChar} X:${Math.round(this.player.x)} Y:${Math.round(this.player.y)} Enemies:${this.enemies.getChildren().length}`);
    }
  };
  Game.prototype.showControlsOverlay=function(){
    const panel=this.add.rectangle(WIDTH/2,HEIGHT/2,600,260,0x000000,0.9).setStrokeStyle(2,0xffffff);
    const lines=['Bewegen: A/D oder ←/→','Springen: W / ↑ / Leertaste','Schießen: F / Strg','Waffen wechseln: 1–5','Spezialfähigkeit: Q (Platzhalter)','Pause/Legende: H oder ESC'];
    this.add.text(panel.x-260,panel.y-110,lines.join('\n'),{fontFamily:'monospace',fontSize:'16px',color:'#ddd'});
    this.input.keyboard.once('keydown-ESC',()=> panel.destroy());
    this.input.keyboard.once('keydown-H',()=> panel.destroy());
  };
  Game.prototype.endLevel=function(){
    const name=prompt('Name für Highscore eintragen:',selectedChar);
    addHighscore({name:name||selectedChar,points:this.points,level:this.levelNum,coins:this.collected});
    this.scene.start('Highscores');
  };
  Game.prototype.gameOver=function(){
    const name=prompt('Game Over. Name für Highscore:',selectedChar);
    addHighscore({name:name||selectedChar,points:this.points,level:this.levelNum,coins:this.collected});
    this.scene.start('Highscores');
  };
  new Phaser.Game(config);
  </script>
</body>
</html>
